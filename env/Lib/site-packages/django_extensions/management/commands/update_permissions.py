# -*- coding: utf-8 -*-
from django.apps import apps as django_apps
<<<<<<< HEAD
from django.contrib.auth.management import create_permissions, _get_all_permissions
=======
from django.contrib.auth.management import create_permissions
from django.contrib.auth.management import _get_all_permissions  # type: ignore
>>>>>>> 6cbdd50e (I commit)
from django.contrib.auth.models import Permission
from django.contrib.contenttypes.models import ContentType
from django.core.management.base import BaseCommand

from django_extensions.management.utils import signalcommand


class Command(BaseCommand):
<<<<<<< HEAD
    help = 'reloads permissions for specified apps, or all apps if no args are specified'

    def add_arguments(self, parser):
        super().add_arguments(parser)
        parser.add_argument('--apps', dest='apps', help='Reload permissions only for apps (comma separated)')
        parser.add_argument('--create-only', action='store_true', default=False, help='Only create missing permissions')
        parser.add_argument('--update-only', action='store_true', default=False, help='Only update permissions')

    @signalcommand
    def handle(self, *args, **options):
        if options['apps']:
            app_names = options['apps'].split(',')
=======
    help = (
        "reloads permissions for specified apps, or all apps if no args are specified"
    )

    def add_arguments(self, parser):
        super().add_arguments(parser)
        parser.add_argument(
            "--apps",
            dest="apps",
            help="Reload permissions only for apps (comma separated)",
        )
        parser.add_argument(
            "--create-only",
            action="store_true",
            default=False,
            help="Only create missing permissions",
        )
        parser.add_argument(
            "--update-only",
            action="store_true",
            default=False,
            help="Only update permissions",
        )

    @signalcommand
    def handle(self, *args, **options):
        if options["apps"]:
            app_names = options["apps"].split(",")
>>>>>>> 6cbdd50e (I commit)
            apps = [django_apps.get_app_config(x) for x in app_names]
        else:
            apps = django_apps.get_app_configs()

<<<<<<< HEAD
        if options['create_only']:
            do_create, do_update = True, False
        elif options['update_only']:
=======
        if options["create_only"]:
            do_create, do_update = True, False
        elif options["update_only"]:
>>>>>>> 6cbdd50e (I commit)
            do_create, do_update = False, True
        else:
            do_create, do_update = True, True

        for app in apps:
            if do_create:
                # create permissions if they do not exist
<<<<<<< HEAD
                create_permissions(app, options['verbosity'])
=======
                create_permissions(app, options["verbosity"])
>>>>>>> 6cbdd50e (I commit)

            if do_update:
                # update permission name's if changed
                for model in app.get_models():
                    content_type = ContentType.objects.get_for_model(model)
                    for codename, name in _get_all_permissions(model._meta):
                        try:
<<<<<<< HEAD
                            permission = Permission.objects.get(codename=codename, content_type=content_type)
=======
                            permission = Permission.objects.get(
                                codename=codename, content_type=content_type
                            )
>>>>>>> 6cbdd50e (I commit)
                        except Permission.DoesNotExist:
                            continue
                        if permission.name != name:
                            old_str = str(permission)
                            permission.name = name
<<<<<<< HEAD
                            if options['verbosity'] >= 2:
                                self.stdout.write(self.style.SUCCESS("Update permission '%s' to '%s'" % (old_str, permission)))
=======
                            if options["verbosity"] >= 2:
                                self.stdout.write(
                                    self.style.SUCCESS(
                                        "Update permission '%s' to '%s'"
                                        % (old_str, permission)
                                    )
                                )
>>>>>>> 6cbdd50e (I commit)
                            permission.save()
